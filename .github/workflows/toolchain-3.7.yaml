name: toolchain-3.7

on:
  push:
    branches:
      - '3.7'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    name: Build 3.7 toolchain
    runs-on: ubuntu-latest

    steps:
      - name: Clone repo
        uses: actions/checkout@v4

      - name: Setup toolchain vars.mk
        run: |
          sed 's|^CLFS.*|CLFS = /opt/arm-linux-gnu/clfs|' -i vars.mk
          sed 's|^CROSSTOOLS.*|CROSSTOOLS = /opt/arm-linux-gnu/crosstools|' -i vars.mk

      - name: Download source files
        run: |
          make download

      - name: Build linux-headers
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          # Create a bind mount from the current workspace to /opt/arm-linux-gnu
          # github.workspace includes all of the code checked out from our current repo
          # so anything done to this code will then be available to any following step
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make linux-headers -C /opt/arm-linux-gnu

      - name: Build libgmp
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make libgmp -C /opt/arm-linux-gnu

      - name : Build libmpfr
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make libmpfr -C /opt/arm-linux-gnu

      - name : Build libmpc
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make libmpc -C /opt/arm-linux-gnu

      - name: Build binutils
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make binutils -C /opt/arm-linux-gnu

      - name: Build gcc-static
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make gcc-static -C /opt/arm-linux-gnu

      - name: Build make
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make make -C /opt/arm-linux-gnu

      - name: Build glibc
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make glibc -C /opt/arm-linux-gnu

      - name: Build gcc-final
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make gcc-final -C /opt/arm-linux-gnu

      - name: Test toolchain
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            make test -C /opt/arm-linux-gnu

      - name: Package toolchain
        uses: addnab/docker-run-action@v3
        with:
          image: sepen/crux:3.7
          options: -v ${{ github.workspace }}:/opt/arm-linux-gnu
          run: |
            tar cvJf /opt/arm-linux-gnu/crux-toolchain-arm-linux-gnu-3.7-$(date +'%Y%m%d%H%M').tar.xz /opt/arm-linux-gnu/crosstools /opt/arm-linux-gnu/clfs

      - name: Release toolchain
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avz
          path: /tmp/release/
          remote_path: /home/frs/project/crux-arm/toolchain/
          remote_host: frs.sourceforge.net
          remote_user: sepen
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }} 
